---
- name: Merge Kubeconfig Locally
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    # The new config file to merge (relative to where you run the playbook)
    new_config_file: "kubeconfig_cg_cluster.yaml"
    kube_dir: "{{ ansible_env.HOME }}/.kube"
    main_config: "{{ kube_dir }}/config"

  tasks:
    - name: Check if new config file exists
      ansible.builtin.stat:
        path: "{{ new_config_file }}"
      register: new_config_stat

    - name: Fail if new config file is missing
      ansible.builtin.fail:
        msg: "Could not find {{ new_config_file }}. Please make sure it is in the current directory."
      when: not new_config_stat.stat.exists

    - name: Ensure .kube directory exists
      ansible.builtin.file:
        path: "{{ kube_dir }}"
        state: directory
        mode: '0755'

    - name: Check if main config exists
      ansible.builtin.stat:
        path: "{{ main_config }}"
      register: main_config_stat

    - name: Backup existing config
      ansible.builtin.copy:
        src: "{{ main_config }}"
        dest: "{{ main_config }}.bak.{{ ansible_date_time.iso8601_basic_short }}"
        mode: '0600'
      when: main_config_stat.stat.exists

    - name: Copy new config if main config does not exist
      ansible.builtin.copy:
        src: "{{ new_config_file }}"
        dest: "{{ main_config }}"
        mode: '0600'
      when: not main_config_stat.stat.exists

    - name: Merge configs if main config exists
      ansible.builtin.shell: |
        KUBECONFIG="{{ main_config }}:{{ new_config_file }}" kubectl config view --flatten > "{{ main_config }}.merged"
        mv "{{ main_config }}.merged" "{{ main_config }}"
        chmod 600 "{{ main_config }}"
      when: main_config_stat.stat.exists
      args:
        executable: /bin/bash

    - name: Success message
      ansible.builtin.debug:
        msg: "Successfully merged {{ new_config_file }} into {{ main_config }}."
