#!/usr/bin/nft -f
flush ruleset

table inet filter {
  chain input {
    type filter hook input priority filter; policy drop;

    iif lo accept
    ct state established,related accept
    ip protocol icmp accept
    ip6 nexthdr ipv6-icmp accept
    tcp dport ssh accept

    # Allow ALL traffic from the physical nodes in the cluster
    # (This ensures nodes can talk to each other's Kubelets/APIs)
    {% for host in (groups[server_group] + groups[agent_group] | default([])) | unique %}
    ip saddr {{ hostvars[host].ansible_default_ipv4.address }} accept
    {% endfor %}

    # K3s Essential Ports
    tcp dport {{ api_port | default(6443) }} accept
    udp dport { 8472, 51820, 51821 } accept # Flannel/Wireguard
    tcp dport { 10250, 10248 } accept       # Kubelet
    
    # Allow Pod-to-Node communication
    ip saddr {{ cluster_cidr | default('10.42.0.0/16') }} accept
    ip saddr {{ service_cidr | default('10.43.0.0/16') }} accept

    # NodePorts
    tcp dport 30000-32767 accept
    udp dport 30000-32767 accept
  }

  chain forward {
    type filter hook forward priority filter; policy accept;
    # We set policy to accept for K3s/CNI to manage forwarding rules via iptables-nft
    # but we still filter for safety if desired.
    ct state established,related accept
  }

  chain output {
    type filter hook output priority filter; policy accept;
  }
}

# Proper NAT table for Masquerading
table inet nat {
  chain postrouting {
    type nat hook postrouting priority srcnat; policy accept;
    ip saddr {{ cluster_cidr | default('10.42.0.0/16') }} masquerade
  }
}