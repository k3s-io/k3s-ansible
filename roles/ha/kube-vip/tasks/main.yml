---
# Recommended in https://kube-vip.io/usage/k3s/
# See "Clean Environment".
- name: Reset local interface
  command: "{{ item }}"
  with_items:
    - ip addr flush dev lo
    - ip addr add 127.0.0.1/8 dev lo
  failed_when: false

- name: Create manifest directory {{ ha_cluster_method }}
  file:
    path: "{{ data_dir }}/server/manifests/{{ ha_cluster_method }}"
    state: directory
    owner: root
    group: root
    mode: "u=rwx,g=,o="
  register: manifest_dir

- name: Copy RBAC manifest
  template:
    src: "cluster-method/{{ ha_cluster_method }}/kube-vip-rbac.yaml.j2"
    dest: "{{ manifest_dir.path }}/kube-vip-rbac.yaml"
    owner: root
    group: root
    mode: "u=rw,g=,o="

- name: Copy arp daemonset manifest
  template:
    src: "cluster-method/{{ ha_cluster_method }}/kube-vip-arp-ds.yaml.j2"
    dest: "{{ manifest_dir.path }}/kube-vip-arp-ds.yaml"
    owner: root
    group: root
    mode: "u=rw,g=,o="

