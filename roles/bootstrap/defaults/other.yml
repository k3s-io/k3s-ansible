---
kubernetes_reflector_helm_values: {}

kubernetes_reloader_helm_values: {}

argocd_enabled: false
argocd_namespaces:
  - default
argocd_helm_secrets:
  security.yaml: |
    security_github_client_id: "{{ security_github_client_id }}"
    security_github_client_secret: "{{ security_github_client_secret }}"
    security_github_organizations: "{{ security_github_organizations }}"
argocd_helm_values:
  # custom values from https://github.com/argoproj/argo-helm/blob/main/charts/argo-cd/values.yaml
  global:
    domain: "automation-argo-cd.{{ ingress_hostname }}"
    logging:
      level: "info"
  configs:
    params:
      application.namespaces: "{{ argocd_namespaces | join(', ') }}"
      dexserver.disable.tls: true
      server.disable.auth: "{{ not (security_enabled | lower == 'true') }}"
      server.insecure: true
    cm:
      admin.enabled: "{{ not (security_enabled | lower == 'true') }}"
      exec.enabled: true
      users.anonymous.enabled: "{{ not (security_enabled | lower == 'true') }}"
      url: "https://automation-argo-cd.{{ ingress_hostname }}"
      resource.exclusions: |
        - apiGroups:
          - "velero.io"
          kinds:
          - "Backup"
          clusters:
          - "*"
      dex.config: |
        connectors:
          - type: oidc
            id: oidc
            name: IAM
            config:
              issuer: https://security-dex.{{ ingress_hostname }}/dex
              clientID: argo-cd
              clientSecret: $security_github_client_secret
      resource.customizations: |
        networking.k8s.io/Ingress:
          health.lua: |
            hs = {}
            
            if obj.status ~= nil then
              hs.status = "Healthy"
              hs.message = "Ingress created"
              return hs
            end

            hs.status = "Progressing"
            hs.message = "Waiting for creation"
            return hs
    cmp:
      create: true
      plugins:
        helmfile:
          allowConcurrency: true
          discover:
            fileName: "helmfile.yaml*"
          generate:
            command:
              - bash
              - /helmfile-scripts/argo-cd-helmfile.sh

          lockRepo: false
    rbac:
      policy.default: "role:admin"

    credentialTemplates: "{{argocd_credential_templates}}"

    secret:
      extra:
        security_github_client_id: "{{ security_github_client_id }}"
        security_github_client_secret: "{{ security_github_client_secret }}"
        security_github_organizations: "{{ security_github_organizations }}"
  applicationSet:
    metrics:
      enabled: "{{ enable_service_monitors }}"
      serviceMonitor:
        enabled: "{{ enable_service_monitors }}"
  controller:
    metrics:
      enabled: "{{ enable_service_monitors }}"
      serviceMonitor:
        enabled: "{{ enable_service_monitors }}"
  dex:
    enable: "{{ security_enabled }}"
    livenessProbe:
      enabled: true
    readinessProbe:
      enabled: true
    metrics:
      enabled: "{{ enable_service_monitors }}"
      serviceMonitor:
        enabled: "{{ enable_service_monitors }}"
  repoServer:
    clusterRoleRules:
      enabled: true
    metrics:
      enabled: "{{ enable_service_monitors }}"
      serviceMonitor:
        enabled: "{{ enable_service_monitors }}"
    extraContainers:
      - name: helmfile
        image: ghcr.io/helmfile/helmfile:v0.163.1
        command: ["/var/run/argocd/argocd-cmp-server"]
        env:
          - name: HELM_CACHE_HOME
            value: /tmp/helm/cache
          - name: HELM_CONFIG_HOME
            value: /tmp/helm/config
          - name: HELMFILE_CACHE_HOME
            value: /tmp/helmfile/cache
          - name: HELMFILE_TEMPDIR
            value: /tmp/helmfile/tmp
        securityContext:
          runAsNonRoot: true
          runAsUser: 999
        volumeMounts:
          - mountPath: /var/run/argocd
            name: var-files
          - mountPath: /home/argocd/cmp-server/plugins
            name: plugins
          - mountPath: /home/argocd/cmp-server/config/plugin.yaml
            subPath: helmfile.yaml
            name: argocd-cmp-cm
          - mountPath: /tmp
            name: helmfile-tmp
          - name: helmfile-scripts
            mountPath: /helmfile-scripts/
          - name: helm-values
            mountPath: /helm-values/
    volumeMounts:
      - name: helm-values
        mountPath: /helm-values/
    volumes:
      - name: argocd-cmp-cm
        configMap:
          name: argocd-cmp-cm
      - name: helmfile-scripts
        configMap:
          name: argocd-helmfile
      - name: helmfile-tmp
        emptyDir: {}
      - name: helm-values
        secret:
          secretName: argocd-helm-values
          optional: true
  server:
    metrics:
      enabled: "{{ enable_service_monitors }}"
      serviceMonitor:
        enabled: "{{ enable_service_monitors }}"
    ingress:
      enabled: true
      ingressClassName: "nginx"
      hostname: "automation-argo-cd.{{ ingress_hostname }}"
      path: /
      tls: false

      annotations:
        gethomepage.dev/enabled: "true"
        gethomepage.dev/name: "Argo CD"
        gethomepage.dev/pod-selector: "app.kubernetes.io/name=argocd-server"
        gethomepage.dev/description: "Declarative Continuous Deployment for Kubernetes"
        gethomepage.dev/group: "Automation"
        gethomepage.dev/icon: "sh-argo-cd"
  extraObjects:
    - apiVersion: v1
      kind: Secret
      metadata:
        name: argocd-helm-values
      stringData: "{{ argocd_helm_secrets }}"
    - apiVersion: v1
      kind: ConfigMap
      metadata:
        name: argocd-helmfile
      data:
        argo-cd-helmfile.sh: |
          PARAMS=()                

          if [[ -v ARGOCD_APP_NAMESPACE ]]; then
            PARAMS+=(-n $ARGOCD_APP_NAMESPACE)
          fi

          if [[ -v ENV_NAME ]]; then
            PARAMS+=(-e $ENV_NAME)
          elif [[ -v ARGOCD_ENV_ENV_NAME ]]; then
            PARAMS+=(-e $ARGOCD_ENV_ENV_NAME)
          fi

          PARAMS+=(template --include-crds -q)

          if [[ -v ARGOCD_APP_NAMESPACE ]]; then
            PARAMS+=(-n $ARGOCD_APP_NAMESPACE)
          fi

          for f in $(ls /helm-values/); do
            PARAMS+=(--state-values-file /helm-values/$f)
          done

          LOG_FILE="/tmp/helmfile_${ARGOCD_APP_NAME}_$(date +'%Y%m%d%H%M').log"

          echo "##########################################" >> "$LOG_FILE"
          echo "Start helmfile for $ARGOCD_APP_NAME" >> "$LOG_FILE"
          echo "##########################################" >> "$LOG_FILE"

          helmfile "${PARAMS[@]}" | tee -a "$LOG_FILE"
          test "${PIPESTATUS[0]}" -eq 0

k8s_device_plugin_enabled: false
k8s_device_plugin_helm_values:
  runtimeClassName: nvidia
