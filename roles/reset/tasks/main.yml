---

##########################
# Remove HA cluster method

- name: Include role, {{ role }}
  vars:
    role: "reset/ha/{{ ha_cluster_method }}"
  include_role:
    name: "{{ role }}"
  when:
    - ha_enabled
    - ha_cluster_method != 'external'
    - inventory_hostname in groups['k3s_server']

###########################
# Start of k3s-killall.sh #
###########################

#
# for service in /etc/systemd/system/k3s*.service; do
#    [ -s $service ] && systemctl stop $(basename $service)
# done
#
- name: Disable services
  systemd:
    name: "{{ item }}"
    state: stopped
    enabled: no
  failed_when: false
  loop: "{{ k3s_services }}"

#
# killtree $({ set +x; } 2>/dev/null; getshims; set -x)
#
- name: pkill -9 -f "{{ data_dir }}/data/[^/]+/bin/containerd-shim"
  register: pkill_containerd_shim
  command: pkill -9 -f "{{ data_dir }}/data/[^/]+/bin/containerd-shim"
  changed_when: "pkill_containerd_shim.rc == 0"
  failed_when: false

#
#
# do_unmount_and_remove [the list]
#
- name: Umount k3s filesystems and remove mount points
  include_tasks: umount_with_children.yml
  loop:
    - /run/k3s
    - "{{ data_dir }}"
    - /var/lib/kubelet/pods
    - /var/lib/kubelet/plugins
    - /run/netns/cni-
  loop_control:
    loop_var: mounted_fs

#
# Remove CNI namespaces
# ip netns show 2> /dev/null | grep cni- | xargs -r -t -n 1 ip netns delete
#
- name: Show CNI namespaces
  register: ip_netns_show
  command: ip -j netns show master cni0
  changed_when: false

#
# BUG: Possible bug in ip-netns(8) on Raspbian.
# "ip -j netns show master cni0" does not always report "[ ]" but returns 0 when there is no master.
#
- name: Remove CNI namespaces
  command: ip netns delete {{ item }}
  loop: "{{ (ip_netns_show.stdout if ip_netns_show.stdout != '' else  '[ ]') | from_json | json_query('[*].name') }}"

#
# Remove CNI interfaces
# ip link show 2>/dev/null | grep 'master cni0'
#
# BUG: Possible bug in ip-link(8) on Raspbian.
# "ip -j link show master cni0" exits 255 when cni0 does not exist where
# "ip -j netns show master cni0" reports "[ ]", which is preferred.
#
- name: Get list of network interface(s) that match 'master cni0'
  register: ip_link_show
  shell: ip -j link show master cni0 || echo "[ ]"
  changed_when: false

- name: Remove CNI interfaces
  command: ip link delete {{ item }}
  loop: "{{ ip_link_show.stdout | from_json | json_query('[*].ifname') }}"

#
# Remove other interfaces and files
#
- name: Remove other interfaces
  command: ip link delete {{ item }}
  when: item in ansible_interfaces
  loop:
    - cni0
    - flannel.1
    - flannel-v6.1

- name: Remove CNI files
  file:
    path: /var/lib/cni
    state: absent

#
# iptables-save | grep -v KUBE- | grep -v CNI- | iptables-restore
# TODO: Replace with appropriate ansible module
#

- name: Dump iptables
  register: iptables_saved
  command: "iptables-save"
  changed_when: false

- name: Filter entries using regex pattern "{{ pattern }}"
  vars:
    pattern: '(KUBE|CNI)-'
  set_fact:
    iptables_filtered: >-
      {{
        iptables_saved.stdout
        | regex_replace('^.*'+pattern+'.*$', '#', multiline=true)
      }}

- name: Remove "(KUBE|CNI)-" iptables entries
  command:
    cmd: "iptables-restore"
    stdin: "{{ iptables_filtered }}"
  when: iptables_saved.stdout != iptables_filtered

#########################
# End of k3s-killall.sh #
#########################

#
# systemctl disable k3s
# systemctl reset-failed k3s
# systemctl daemon-reload
#
- name: Disable services
  systemd:
    name: "{{ item }}"
    state: stopped
    enabled: no
  failed_when: false
  loop: "{{ k3s_services }}"

- name: daemon_reload
  systemd:
    daemon_reload: yes

#
# rm -f /etc/systemd/system/k3s.service
# rm -f /etc/systemd/system/k3s.service.env
#
- name: Remove service files
  file:
    path: "{{ systemd_dir }}/{{ item }}"
    state: absent
  loop: "{{ k3s_services | product(k3s_service_file_extensions) | map('join', '.') }}"

#
# if (ls /etc/systemd/system/k3s*.service || ls /etc/init.d/k3s*) >/dev/null 2>&1; then
#     set +x; echo 'Additional k3s services installed, skipping uninstall of k3s'; set -x
#    exit
# fi
#
# Should this be done rather than focusing on a discrete list of services (k3s_services)?

#
# for cmd in kubectl crictl ctr; do
#    if [ -L {{ bin_dir }}/$cmd ]; then
#        rm -f {{ bin_dir }}/$cmd
#    fi
# done
#
- name: Remove command files if they are symlink'd
  block:
    - name: Stat command files
      register: stat_command_files
      stat:
        path: "{{ bin_dir }}/{{ item }}"
      loop:
        - kubectl
        - crictl
        - ctr

    - name: Remove command files
      file:
        path: "{{ item.stat.path }}"
        state: absent
      when: (item.stat.exists | default(false)) and (item.stat.islnk | default(false))
      loop: "{{ stat_command_files.results }}"
      loop_control: 
        label: "{{ item.item }}"
  when: inventory_hostname in groups['k3s_server']

# Remove files and directories
- name: Remove files and data
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/rancher/k3s
    - /run/k3s
    - /run/flannel
    - "{{ data_dir }}"
    - /var/lib/kubelet
    - "{{ bin_dir }}/k3s.sh"
    - "{{ bin_dir }}/k3s-killall.sh"    # From https://get.k3s.io
    - "{{ bin_dir }}/k3s-uninstall.sh"  # From https://get.k3s.io

- name: Remove downloaded k3s binary
  file:
    path: "{{ bin_dir }}/k3s"
    state: absent
  when: remove_packages

- name: Remove ~{{ ansible_user }}/.kube/config
  file:
    path: "~{{ ansible_user }}/.kube/config"
    state: absent
  when: inventory_hostname in groups['k3s_server']

- name: Remove package k3s-selinux
  yum:
    name: k3s-selinux
    state: remove
  when:
    - ansible_pkg_mgr == "yum"
    - remove_packages

- name: Remove package k3s-selinux
  zypper:
    name: k3s-selinux
    state: remove
  when:
    - ansible_pkg_mgr == "zypper"
    - remove_packages

- name: Remove yum repo files
  shell: 'rm -f /etc/yum.repos.d/rancher-k3s-common*.repo'
  register: remove_repo_files
  when:
    - ansible_pkg_mgr == "yum"
    - remove_packages

- name: Remove zypper repo files
  shell: 'rm -f /etc/zypp/repos.d/rancher-k3s-common*.repo'
  register: remove_repo_files
  when:
    - ansible_pkg_mgr == "zypper"
    - remove_packages

